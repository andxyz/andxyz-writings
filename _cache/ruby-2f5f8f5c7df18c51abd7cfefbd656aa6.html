<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;digest/md5&#39;</span>

<span class="k">def</span> <span class="nf">gfm</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="c1"># Extract pre blocks</span>
  <span class="n">extractions</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">text</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">%r{&lt;pre&gt;.*?&lt;/pre&gt;}m</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">match</span><span class="o">|</span>
    <span class="n">md5</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="n">extractions</span><span class="o">[</span><span class="n">md5</span><span class="o">]</span> <span class="o">=</span> <span class="n">match</span>
    <span class="s2">&quot;{gfm-extraction-</span><span class="si">#{</span><span class="n">md5</span><span class="si">}</span><span class="s2">}&quot;</span>
  <span class="k">end</span>

  <span class="c1"># prevent foo_bar_baz from ending up with an italic word in the middle</span>
  <span class="n">text</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/(^(?! {4}|\t)\w+_\w+_\w[\w_]*)/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="n">x</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;\_&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">to_s</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;__&#39;</span>
  <span class="k">end</span>

  <span class="c1"># in very clear cases, let newlines become &lt;br /&gt; tags</span>
  <span class="n">text</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/^[\w\&lt;][^\n]*\n+/</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="n">x</span> <span class="o">=~</span> <span class="sr">/\n{2}/</span> <span class="p">?</span> <span class="n">x</span> <span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip!</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;  </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Insert pre block extractions</span>
  <span class="n">text</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\{gfm-extraction-([0-9a-f]{32})\}/</span><span class="p">)</span> <span class="k">do</span>
    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">extractions</span><span class="o">[</span><span class="vg">$1</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="n">text</span>
<span class="k">end</span>
</pre>
</div>
