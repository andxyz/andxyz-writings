<div class="highlight"><pre><code class="text"># prevent foo_bar_baz from ending up with an italic word in the middle
text.gsub!(/(^(?! {4}|\t)\w+_\w+_\w[\w_]*)/) do |x|
  x.gsub(&#39;_&#39;, &#39;\_&#39;) if x.split(&#39;&#39;).sort.to_s[0..1] == &#39;__&#39;
end

# in very clear cases, let newlines become &lt;br /&gt; tags
text.gsub!(/^[\w\&lt;][^\n]*\n+/) do |x|
  x =~ /\n{2}/ ? x : (x.strip!; x &lt;&lt; &quot;  \n&quot;)
end

# Insert pre block extractions
text.gsub!(/\{gfm-extraction-([0-9a-f]{32})\}/) do
  &quot;\n\n&quot; + extractions[$1]
end

text
</code></pre>
</div>
